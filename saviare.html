<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RPV – Saviare</title>
<style>
  body { font-family:"Helvetica Neue", Helvetica, sans-serif; background:#fff; max-width:600px; margin:auto; padding:20px; color:#000; }
  h1 { text-align:center; color:#DA291C; }
  .form-group { margin-bottom:15px; }
  label { font-weight:bold; display:block; margin-bottom:5px; }
  input[type="text"], input[type="date"], textarea { width:100%; padding:10px; border:1px solid #ccc; border-radius:5px; box-sizing:border-box; }
  textarea { resize:vertical; }
  button { width:100%; background:#DA291C; color:#fff; border:none; border-radius:5px; padding:12px; font-size:16px; cursor:pointer; }
  button:hover { background:#b11417; }
  .checkbox-label, .accept-label { display:flex; align-items:center; font-weight:normal; }
  .checkbox-label input, .accept-label input { margin-right:8px; }
  #overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; flex-direction:column; align-items:center; justify-content:center; color:#fff; font-size:18px; z-index:999; display:none; }
  #progressContainer { width:80%; margin-top:20px; display:none; }
  #progressWrapper { background:#eee; border-radius:6px; overflow:hidden; height:14px; }
  #progressBar { height:14px; width:0%; transition:width 0.3s ease; background:#DA291C; }
  #progressPercent { text-align:right; font-size:13px; margin-top:5px; }
</style>
</head>
<body>

<h1>Reporte de Peligros Voluntarios (RPV)</h1>

<form id="rpvForm">
  <div class="form-group">
    <label>Fecha del peligro
      <input type="date" name="fechaPeligro" required>
    </label>
  </div>
  
  <div class="form-group">
    <label>Lugar del peligro
      <input type="text" name="lugar" placeholder="Ej: Plataforma de carga" required>
    </label>
  </div>

  <div class="form-group">
    <label>Base
      <input type="text" name="base" placeholder="Ej: Villavicencio" required>
    </label>
  </div>

  <div class="form-group">
    <label>Nombre
      <input id="nombreInput" name="nombre" type="text" placeholder="Ej: Juan Pérez">
      <label class="checkbox-label"><input type="checkbox" id="anon"> Confidencial</label>
    </label>
  </div>

  <div class="form-group">
    <label>Cargo
      <input name="cargo" type="text" placeholder="Ej: Coordinador de operaciones">
    </label>
  </div>

  <div class="form-group">
    <label>Descripción del peligro
      <textarea name="descripcion" rows="4" placeholder="Ej: Falla en procedimiento…" required></textarea>
    </label>
  </div>

  <div class="form-group">
    <label>Evidencia (PDF/imagen/video, máx 10 MB c/u)
      <input type="file" id="files" name="files" multiple accept="image/*,application/pdf,video/*">
    </label>
  </div>

  <div class="form-group">
    <label class="accept-label">
      <input type="checkbox" id="acepto" required>
      He leído y acepto el uso y tratamiento de mis datos personales.
    </label>
  </div>

  <button type="submit">Enviar reporte</button>
</form>

<div id="overlay">
  ⏳ Subiendo archivos…
  <div id="progressContainer">
    <div id="progressWrapper"><div id="progressBar"></div></div>
    <div id="progressPercent">0%</div>
  </div>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbxk66ZbJrxJmUKJjCWdag4RYzqDdvXctSvHkQOvwsOn5OFGO_Oib-IhjixIiJQXrm9_/exec';

const overlay = document.getElementById('overlay');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const progressPercent = document.getElementById('progressPercent');

document.getElementById('anon').addEventListener('change', e => {
  const n = document.getElementById('nombreInput');
  if(e.target.checked){ n.value=''; n.disabled=true; n.placeholder=''; n.style.background='#f2f2f2'; }
  else{ n.disabled=false; n.placeholder='Ej: Juan Pérez'; n.style.background='#fff'; }
});

document.getElementById('rpvForm').addEventListener('submit', async e => {
  e.preventDefault();
  if(!document.getElementById('acepto').checked){ alert('Debe aceptar el tratamiento de datos.'); return; }

  const form = e.target;
  const filesInput = document.getElementById('files');
  const anonimo = document.getElementById('anon').checked;
  const nombreFinal = anonimo ? 'Anónimo' : form.nombre.value;

  let totalSize=0; for(const f of filesInput.files) totalSize+=f.size;
  if(totalSize>15*1024*1024){ alert('El total de adjuntos supera 15 MB.'); return; }

  overlay.style.display='flex'; progressContainer.style.display=filesInput.files.length>0?'block':'none';

  const files=[]; let uploaded=0;
  for(const f of filesInput.files){
    if(f.size>10*1024*1024){ alert(`Archivo ${f.name} supera 10 MB y se omite.`); continue; }
    const base64 = await new Promise(res=>{
      const reader=new FileReader();
      reader.onload=()=>res(reader.result.split(',')[1]);
      reader.readAsDataURL(f);
    });
    uploaded+=f.size;
    if(totalSize>0){ const percent=Math.round((uploaded/totalSize)*80); progressBar.style.width=percent+'%'; progressPercent.textContent=percent+'%'; }
    files.push({name:f.name, mimeType:f.type, base64});
  }

  const payload = {
    fechaPeligro: form.fechaPeligro.value,
    lugar: form.lugar.value,
    base: form.base.value,
    nombre: nombreFinal,
    cargo: form.cargo.value,
    descripcion: form.descripcion.value,
    anonimo: anonimo,
    files
  };

  progressBar.style.width='90%'; progressPercent.textContent='90%';

  await fetch(scriptURL, { method:'POST', mode:'no-cors', body:JSON.stringify(payload) });

  progressBar.style.width='100%'; progressPercent.textContent='100%';
  setTimeout(()=>{
    overlay.style.display='none'; progressContainer.style.display='none';
    progressBar.style.width='0%'; progressPercent.textContent='0%';
    alert('✅ ¡Reporte enviado!');
    form.reset();
    document.getElementById('nombreInput').disabled=false;
    document.getElementById('nombreInput').placeholder='Ej: Juan Pérez';
    document.getElementById('nombreInput').style.background='#fff';
  },700);
});
</script>
</body>
</html>
