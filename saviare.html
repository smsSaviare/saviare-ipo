<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IPO ‚Äì Saviare LTDA</title>
<link rel="icon" href="data:image/svg+xml;utf8,
  <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
    <text y='0.9em' font-size='90'>üçÄ</text>
  </svg>">
<style>
  :root{
    --green-1:#00b09b;
    --green-2:#96c93d;
    --green-3:#0da574;
    --text:#ffffff;
    --glass:rgba(255,255,255,.12);
    --glass-strong:rgba(255,255,255,.18);
    --shadow:0 10px 30px rgba(0,0,0,.18);
    --ring:#b9ffd6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(1000px 600px at -10% -10%, rgba(255,255,255,.08), transparent 40%),
      radial-gradient(800px 500px at 110% 0%, rgba(0,0,0,.12), transparent 45%),
      linear-gradient(135deg,var(--green-1),var(--green-2));
    display:flex;
    flex-direction:column;
    align-items:center;
    overflow-x:hidden;
  }
  /* Glow suave animado del fondo */
  body::before, body::after{
    content:"";
    position:fixed;
    width:60vmax;height:60vmax;border-radius:50%;
    filter:blur(90px);opacity:.15;z-index:-1;
    background:conic-gradient(from 120deg,#e8ffb4,transparent 40%,#8ef8c2 60%,transparent);
    animation:orbit 18s linear infinite;
  }
  body::after{ animation-direction:reverse; opacity:.18; filter:blur(110px); }
  @keyframes orbit{ to{ transform:rotate(360deg); } }
  @media (prefers-reduced-motion:reduce){
    .plane, body::before, body::after{ animation:none !important; }
  }

  /* Bienvenida (no bloquea interacci√≥n) */
  #welcomeOverlay{
    position:fixed; inset:0;
    display:flex; align-items:center; justify-content:center;
    padding:24px; text-align:center;
    background:linear-gradient(135deg, rgba(0,176,155,.9), rgba(150,201,61,.92));
    z-index:999;
    pointer-events:none;           /* <- no bloquea el formulario */
    opacity:1; transition:opacity .9s ease;
    overflow:hidden;
  }
  #welcomeOverlay.fade-out{ opacity:0; }

  .welcome-inner{
    position:relative;
    max-width:900px; width:100%;
    padding:32px 16px;
  }
  .welcome-title{
    font-size:clamp(20px,4.5vw,36px);
    font-weight:800;
    letter-spacing:.3px;
    margin:0;
    display:flex; gap:.5rem; align-items:center; justify-content:center;
    opacity:0; animation:fadeInTitle 1.2s ease .3s forwards;
    text-shadow:0 3px 12px rgba(0,0,0,.25);
  }
  .welcome-title .clover{filter:drop-shadow(0 3px 8px rgba(0,0,0,.25))}
  @keyframes fadeInTitle{ to{opacity:1} }

  /* Avi√≥n */
  .plane{
    position:absolute;
    bottom:10vh;                  /* m√°s abajo para que se vea */
    left:-30vw;                   /* arranca fuera de pantalla */
    width:min(140px,26vw);
    filter:drop-shadow(0 18px 18px rgba(0,0,0,.35));
    opacity:.95;
    transform:translateX(0) translateY(0) rotate(0);
    animation:planeFly 3.2s ease-in-out .15s forwards;
  }
  @keyframes planeFly{
    0%   { transform:translateX(0) translateY(0) rotate(0deg); }
    70%  { transform:translateX(115vw) translateY(-6vh) rotate(14deg); }
    100% { transform:translateX(140vw) translateY(-10vh) rotate(18deg); opacity:0; }
  }

  /* Contenedor principal */
  .wrap{
    width:min(940px,92vw);
    margin: clamp(20px, 4vh, 36px) auto 40px;
  }
  .card{
    background:var(--glass);
    border:1px solid rgba(255,255,255,.16);
    box-shadow:var(--shadow);
    backdrop-filter:blur(10px);
    border-radius:18px;
    padding:20px;
  }
  header.page{
    display:flex; align-items:center; gap:12px;
    margin-bottom:14px;
  }
  header.page .brand{
    width:40px; height:40px; display:grid; place-items:center;
    background:var(--glass-strong);
    border:1px solid rgba(255,255,255,.18);
    border-radius:12px;
  }
  header.page h1{
    font-size:clamp(20px,3.4vw,28px);
    margin:0 0 2px 0;
    font-weight:800;
    letter-spacing:.2px;
    position:relative;
  }
  header.page h1::after{
    content:"";
    position:absolute;left:0;bottom:-6px;
    width:72px;height:3px;border-radius:3px;
    background:linear-gradient(90deg,#e8ffb4,#8ef8c2);
    opacity:.9;
  }
  header.page p{
    margin:10px 0 0; opacity:.9; font-size:.95rem;
  }

  /* Formulario */
  form{ margin-top:8px; }
  .grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:14px;
  }
  .grid-1{ display:grid; grid-template-columns:1fr; gap:14px; }
  @media (max-width:720px){ .grid{ grid-template-columns:1fr; } }

  label{ font-weight:700; font-size:.92rem; margin-bottom:6px; display:block; }
  input[type="text"], input[type="date"], select, textarea{
    width:100%;
    padding:12px 12px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.22);
    outline:none;
    color:var(--text);
    background:rgba(255,255,255,.08);
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  input::placeholder, textarea::placeholder{ color:rgba(255,255,255,.65); }
  input:focus, select:focus, textarea:focus{
    border-color:rgba(255,255,255,.35);
    box-shadow:0 0 0 3px rgba(185,255,214,.28);
    background:rgba(255,255,255,.12);
  }
  textarea{ min-height:120px; resize:vertical; }

  .file{
    border:1px dashed rgba(255,255,255,.35);
    border-radius:12px;
    padding:14px;
    background:rgba(255,255,255,.06);
  }

  .terms{
    background:rgba(0,0,0,.22);
    border:1px solid rgba(255,255,255,.18);
    border-radius:14px;
    padding:12px 14px;
    font-size:.92rem;
    line-height:1.35rem;
  }
  .terms p{ margin:.2rem 0 .6rem; }
  .terms .row{ display:flex; gap:8px; align-items:flex-start; }
  .terms input[type="checkbox"]{ margin-top:3px; accent-color:#7ef5b7; }

  .actions{ margin-top:8px; }
  button{
    width:100%;
    padding:13px 16px;
    border:none; border-radius:12px;
    font-weight:800; letter-spacing:.3px;
    color:#0b1f16;
    background:
      linear-gradient(135deg,#e8ffb4,#8ef8c2);
    cursor:pointer;
    box-shadow:0 8px 18px rgba(0,0,0,.18);
    transition:transform .08s ease, filter .2s ease, box-shadow .2s ease;
  }
  button:hover{ filter:brightness(1.06); box-shadow:0 10px 24px rgba(0,0,0,.22);}
  button:active{ transform:translateY(1px) scale(.998); }

  /* Overlay de carga */
  #overlay{
    position:fixed; inset:0; display:none;
    background:rgba(0,0,0,.65);
    color:#fff; z-index:1000;
    align-items:center; justify-content:center; flex-direction:column;
    padding:20px; text-align:center;
  }
  #progressWrap{
    width:min(560px,86vw); margin-top:14px;
    background:#eaeaea; border-radius:10px; overflow:hidden;
    box-shadow:inset 0 0 8px rgba(0,0,0,.12);
  }
  #bar{ height:14px; width:0%; background:#00d2a0; transition:width .25s ease; }
  #percent{ margin-top:6px; font-size:.9rem; opacity:.9; }
</style>
</head>
<body>

<!-- Bienvenida -->
<div id="welcomeOverlay">
  <div class="welcome-inner">
    <img src="Avion.png" class="plane" alt="Avi√≥n">
    <h2 class="welcome-title"><span class="clover">üçÄ</span> ¬°Bienvenido al sistema IPO de Saviare LTDA!</h2>
  </div>
</div>

<div class="wrap">
  <!-- Encabezado -->
  <div class="card" style="margin-bottom:14px;">
    <header class="page">
      <div class="brand" aria-hidden="true">üçÄ</div>
      <div>
        <h1>Informe de Peligro Operacional (IPO)</h1>
        <p>Reporte moderno, confidencial y oportuno para la seguridad operacional.</p>
      </div>
    </header>
  </div>

  <!-- Formulario -->
  <div class="card">
    <form id="ipoForm" novalidate>
      <div class="grid">
        <div>
          <label for="fechaPeligro">Fecha del peligro</label>
          <input id="fechaPeligro" name="fechaPeligro" type="date" required />
        </div>

        <div>
          <label for="base">Base</label>
          <select id="base" name="base" required>
            <option value="" disabled selected>Selecciona una base</option>
            <option value="Villavicencio">Villavicencio</option>
            <option value="Mit√∫">Mit√∫</option>
          </select>
        </div>

        <div class="grid-1">
          <label for="lugar">Lugar del peligro / fase de vuelo</label>
          <input id="lugar" name="lugar" type="text" placeholder="Ej: Plataforma / Rodaje / Despegue‚Ä¶" required />
        </div>

        <div>
          <label for="nombre">Nombre</label>
          <input id="nombre" name="nombre" type="text" placeholder="Opcional" />
        </div>

        <div>
          <label for="cargo">Cargo</label>
          <input id="cargo" name="cargo" type="text" placeholder="Ej: Piloto / T√©cnico / Coordinador‚Ä¶" />
        </div>

        <div class="grid-1">
          <label for="descripcion">Descripci√≥n del peligro / error humano</label>
          <textarea id="descripcion" name="descripcion" placeholder="Describe lo ocurrido‚Ä¶" required></textarea>
        </div>

        <div class="grid-1">
          <label for="files">Evidencia (PDF/imagen/video, m√°x 10 MB c/u)</label>
          <div class="file">
            <input id="files" name="files" type="file" multiple accept="image/*,application/pdf,video/*" />
          </div>
        </div>
      </div>

      <div class="terms" style="margin-top:10px;">
        <p>
          <strong>T√©rminos y condiciones:</strong><br>
          SAVIARE LTDA, promueve e incentiva los Informes de Peligros Operacional (IPO) de forma
          voluntaria y oportuna de cada una de las condiciones latentes de inseguridad y riesgos que
          puedan comprometer todas las actividades de seguridad operacional. Garantizando la
          confidencialidad, protecci√≥n y discreci√≥n de los empleados, por ello no generar√° acciones
          legales disciplinarias en contra de la persona que reporte voluntariamente cualquier
          condici√≥n de inseguridad en forma impresa o verbal a menos que incurran en actos ilegales
          deliberados, negligencia o violaciones a las normas, regulaciones o procedimientos
          estandarizados.
        </p>
        <div class="row">
          <input id="acepto" type="checkbox" required />
          <label for="acepto" style="font-weight:600; margin:0;">He le√≠do y acepto los t√©rminos y condiciones.</label>
        </div>
      </div>

      <div class="actions">
        <button type="submit">Enviar reporte üçÄ</button>
      </div>
    </form>
  </div>
</div>

<!-- Overlay de carga -->
<div id="overlay" role="alert" aria-live="polite">
  <div>‚è≥ Enviando reporte‚Ä¶</div>
  <div id="progressWrap"><div id="bar"></div></div>
  <div id="percent">0%</div>
</div>

<script>
  /* === CONFIG === */
  const scriptURL = "https://script.google.com/macros/s/AKfycbyYxKo88EvsBXTEW7VkGDXmbKmRqNik_-EdzsvKWnNEwiR_ro6E-VPSSi2lvoPnCVqu/exec";

  /* === Bienvenida: fade-out autom√°tico, no bloquea UI === */
  const welcome = document.getElementById('welcomeOverlay');
  // Oculta con fade-out a los ~2.8s (coincide con el vuelo del avi√≥n)
  setTimeout(() => {
    if (welcome) {
      welcome.classList.add('fade-out');
      setTimeout(() => (welcome.style.display = 'none'), 900);
    }
  }, 2800);
  // Fallback: si todo tarda, oculta a los 5s s√≠ o s√≠
  setTimeout(() => { if (welcome) welcome.style.display = 'none'; }, 5000);

  /* === Utilidades de progreso === */
  const overlay = document.getElementById('overlay');
  const bar = document.getElementById('bar');
  const percent = document.getElementById('percent');
  function showOverlay(){ overlay.style.display = 'flex'; }
  function hideOverlay(){ overlay.style.display = 'none'; bar.style.width = '0%'; percent.textContent = '0%'; }
  function setProgress(p){ bar.style.width = p + '%'; percent.textContent = p + '%'; }

  /* === Lector de archivos a base64 (secuencial para progreso) === */
  function readFileAsBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  /* === Env√≠o del formulario (misma l√≥gica que ya funciona) === */
  document.getElementById('ipoForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validaci√≥n de checkbox
    if (!document.getElementById('acepto').checked) {
      alert('Debe aceptar los t√©rminos y condiciones.');
      return;
    }

    const form = e.target;
    const filesInput = document.getElementById('files');

    // Validaciones de tama√±o
    let totalSize = 0;
    for (const f of filesInput.files) totalSize += f.size;
    if (totalSize > 15 * 1024 * 1024) {
      alert('El total de adjuntos supera 15 MB.');
      return;
    }

    showOverlay();

    // Convertir archivos a base64 con progreso (hasta 80%)
    const files = [];
    let uploaded = 0;
    const maxEnc = Math.max(totalSize, 1); // evita div/0
    for (const f of filesInput.files) {
      if (f.size > 10 * 1024 * 1024) {
        alert(`El archivo "${f.name}" excede 10 MB y se omitir√°.`);
        continue;
      }
      const dataUrl = await readFileAsBase64(f);
      files.push({
        name: f.name,
        mimeType: f.type || 'application/octet-stream',
        base64: dataUrl.split(',')[1]
      });
      uploaded += f.size;
      const pct = Math.min(80, Math.round((uploaded / maxEnc) * 80));
      setProgress(pct);
    }

    // Construir payload
    const payload = {
      fechaPeligro: form.fechaPeligro.value || '',
      lugar: form.lugar.value || '',
      base: form.base.value || '',
      nombre: form.nombre.value || '',
      cargo: form.cargo.value || '',
      descripcion: form.descripcion.value || '',
      terminos: document.getElementById('acepto').checked ? 'S√≠' : 'No',
      files
    };

    // Marcar 90% mientras enviamos
    setProgress(90);

    // Enviar (no-cors como en el proyecto que s√≠ funciona)
    try {
      await fetch(scriptURL, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify(payload)
      });
      // no-cors => respuesta opaca: asumimos OK si no hubo excepci√≥n
      setProgress(100);
      setTimeout(() => {
        hideOverlay();
        alert('‚úÖ ¬°Reporte enviado!');
        form.reset();
      }, 600);
    } catch (err) {
      console.error(err);
      hideOverlay();
      alert('‚ùå Error al enviar el reporte. Revisa tu conexi√≥n e int√©ntalo nuevamente.');
    }
  });
</script>
</body>
</html>
